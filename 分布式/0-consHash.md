
# 普通 Hash 原理
它是一种摘要算法，即根据原有的内容产生一个简短的摘要结果。
摘要结果跟原内容是相关的，原内容的改变（极大概率）会导致摘要内容的改变。

Hash算法的使用非常广泛，例如：对一段信息生成Hash值后，可以作为校验信息是否发生变更的依据；通过Hash算法，将请求均匀地分配到应用服务器上；使用Hash算法，确保同样的用户总是访问同一个服务器等。

## 说说你知道的几种HASH算法
MD5、SHA-1、SHA-2

# 分布式缓存扩容
- 场景：假设由于业务发展，网站需要将3台缓存服务器扩容至4台。  

- 问题：比如3台服务器扩容至4台服务器，大约有75％（3/4）被缓存了的数据不能正确命中  


# 一致性 Hash 原理 
>增加一台服务器时，此时一般需要进行重新Hash操作，对各个服务器上的数据进行重新分配，此操作几乎涉及所有服务器上的所有数据，工作量极大。

>在分布式系统中，扩容缩容操作极为常见，如果频繁进行重Hash操作显然是不可取的，一是消耗太大，而是可能引发服务的中断。此时，就要采用一致性Hash算法。

一致性Hash算法（Consistent Hashing）是一种hash算法，它**能够在Hash输出空间发生变化时，引起最小的变动**。

## 好的一致性Hash算法应该能够满足以下要求
- 平衡性：这是Hash算法的基本要求，是指哈希的结果均匀地分配在整个输出空间中。   
- 单调性：当发生数据节点变动时，对于相同的数据始终映射到相同的缓冲节点中或者新增加的缓冲节点中，避免无法找到原来的数据。  
- 稳定性：当出现节点坏掉或热点访问而需要动态扩容时，尽量减少数据的移动。显然一般的Hash方法不满足这一点。

## 实现
一致性哈希算法最早在论文《Consistent Hashing and Random Trees: Distributed Caching Protocols for Relieving Hot Spots on the World Wide Web》中提出。  

通过将整个哈希输出空间设置为一个环形区域，减小了输出空间的变化对哈希结果的影响。
![](https://pic2.zhimg.com/80/v2-089ea90a1be0da6c8014d9de81b22ce1_1440w.webp)

具体算法过程为：先构造一个长度为0~x^32的整数环（这个环被称作一致性Hash环），根据节点名称(通常是IP）的Hash值（其分布范围同样为0~x^32）将缓存服务器节点放置在这个Hash环上。然后根据需要缓存的数据的key值计算得到其Hash值（其分布范围也同样为0~x^32），然后在Hash环上顺时针查找距离这个key的Hash值最近的缓存服务器节点，完成key到服务器的Hash映射查找。

当缓存服务器集群需要扩容的时候，只需要将新加入的节点名称(NODE3)的Hash值放入一致性Hash环中，由于key是顺时针查找距离其最近的节点，因此新加入的节点只影响整个环中的一小段。
![](https://pic3.zhimg.com/80/v2-f8d0db76135fb444febc1834e5f26952_1440w.webp)

上图中，加入新节点NODE3后，原来的key大部分还能继续计算到原来的节点，只有key3、key0从原来的NODE1重新计算到NODE3。这样就能保证大部分被缓存的数据还可以继续命中。3台服务器扩容至4台服务器，可以继续命中原有缓存数据的概率是75％，远高于余数Hash的25％，而且随着集群规模越大，继续命中原有缓存数据的概率也逐渐增大，100台服务器扩容增加1台服务器，继续命中的概率是99％。虽然仍有小部分数据缓存在服务器中不能被读到，但是这个比例足够小，通过访问数据库获取也不会对数据库造成致命的负载压力。

具体应用中，这个长度为0~x^32的一致性Hash环通常使用**二叉查找树**实现，Hash查找过程实际上是在二叉查找树中查找不小于查找数的最小数值。当然这个二叉树的最右边叶子节点和最左边的叶子节点相连接，构成环。

# 一致性 Hash 的缺点
![](https://ask.qcloudimg.com/http-save/1692602/r0667ghnr0.jpeg?imageView2/2/w/1620)
服务节点过少的情况下，是不是会导致节点分配不均匀可能会导致**数据倾斜**的问题。

比如上图新加入的节点NODE3只影响了原来的节点NODE1，也就是说一部分一部分原来需要访问NODE1的缓存数据现在需要访问NODE3。但是原来的节点NODE0和NODE2不受影响，这就意味着NODE0和NODE2缓存数据量和负载压力是NODE1与NODE3的两倍。如果4台机器的性能是一样的，那么这种结果显然不是我们需要的。

引入了**虚拟节点机制**：即对每一个服务节点计算多个哈希，每个计算得到的Hash位置都放置一个此服务节点，称虚拟节点。具体可以在服务器ip或主机名的后面增加编号来实现。

[参考](https://zhuanlan.zhihu.com/p/76721465)

